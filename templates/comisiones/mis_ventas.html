<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comisiones - Mis Ventas</title>
    <link rel="stylesheet" href="{% static 'css/mis_ventas.css' %}">
</head>
<body class="mis-ventas-page">
    <div class="page">
        <header class="top">
            <div class="brand">
                <img class="brand-logo" src="{% static 'img/logos/logo-marcos-automocion.png' %}" alt="Marcos Automoci&oacute;n">
            </div>

                        <h1 class="page-title">Portal de comisiones</h1>

            <div class="user-panel" data-user-menu>
                <button
                    type="button"
                    class="user-chip"
                    data-user-menu-toggle
                    aria-haspopup="true"
                    aria-expanded="false"
                    aria-controls="user-menu-dropdown"
                >
                    {% if foto_perfil_url %}
                    <img class="avatar avatar-img user-chip__avatar" src="{{ foto_perfil_url }}" alt="Foto de perfil de {{ usuario_nombre|default:usuario_login }}">
                    {% else %}
                    <div class="avatar user-chip__avatar">{{ usuario_nombre|default:usuario_login|first|upper }}</div>
                    {% endif %}
                    <span class="user-chip__meta">
                        <span class="user-chip__identity">
                            <span class="user-chip__name">{{ usuario_nombre|default:usuario_login }}</span>
                            <span class="user-chip__separator" aria-hidden="true">&middot;</span>
                            <span class="user-chip__sede">{{ sede|default:"--" }}</span>
                        </span>
                        <span class="user-chip__last">&Uacute;lt. conexi&oacute;n: {{ ultima_conexion|date:"d/m/Y H:i" }}</span>
                    </span>
                    <span class="user-chip__chevron" aria-hidden="true">&#9662;</span>
                </button>

                <div id="user-menu-dropdown" class="user-dropdown" data-user-menu-dropdown role="menu" hidden>
                    <a class="user-dropdown__item" href="{% url 'mi_perfil' %}" role="menuitem">Perfil</a>
                    <div class="user-dropdown__separator" role="separator"></div>
                    <form class="user-dropdown__logout-form" method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'login' %}">
                        <button class="user-dropdown__item user-dropdown__item--danger" type="submit" role="menuitem">Cerrar sesi&oacute;n</button>
                    </form>
                </div>
            </div>
        </header>

        <nav class="nav">
            <a href="{% url 'mis_ventas' %}" class="active">Mis Ventas</a>
            <a href="{% url 'mis_incidencias' %}">Mis Incidencias</a>
            <div class="nav-more">
                <button type="button" class="nav-more-toggle" aria-haspopup="true" aria-expanded="false">
                    M&aacute;s
                </button>
                <div class="nav-more-menu" role="menu" aria-label="Secciones secundarias">
                    <a href="{% url 'boletin' %}" role="menuitem">Bolet&iacute;n</a>
                    <a href="{% url 'normativas' %}" role="menuitem">Normativas</a>
                    <a href="{% url 'manuales' %}" role="menuitem">Manuales</a>
                    <a href="{% url 'avisos_sin_leer' %}" role="menuitem">Avisos sin leer</a>
                    <a href="{% url 'vehiculos_en_uso' %}" role="menuitem">Vehiculos en uso</a>
                </div>
            </div>
        </nav>
        

        <section class="content-topbar">
            <button
                class="filters-toggle"
                type="button"
                aria-controls="filtersPanel"
                aria-expanded="true"
            >
                <span class="filters-toggle__icon" aria-hidden="true">&#9776;</span>
                <span class="filters-toggle__label">Filtros</span>
                <span class="filters-toggle__count" data-filters-count {% if not active_filters %}hidden{% endif %}>{{ active_filters|length }}</span>
            </button>
            <div class="content-topbar__kpi">
                <article class="kpi-card">
                    <div class="kpi-card__meta">
                        <h2 class="kpi-card__title">Total ventas periodo</h2>
                        <p class="kpi-card__subtitle">Ventas en el periodo seleccionado</p>
                    </div>
                    <div class="kpi-card__value" aria-label="Total ventas del periodo">
                        {{ total_ventas_periodo }}
                    </div>
                </article>
                <article class="kpi-card">
                    <div class="kpi-card__meta">
                        <h2 class="kpi-card__title">Comparaci&oacute;n mes anterior</h2>
                        <p class="kpi-card__subtitle">Mes anterior: {{ mes_anterior_label }}</p>
                        <p class="kpi-card__comparison">
                            {{ ventas_mes_anterior }} ventas
                        </p>
                    </div>
                    <div class="kpi-card__value kpi-card__value--{{ delta_mes_anterior_estado }}" aria-label="Variacion frente al mes anterior">
                        <span class="kpi-card__trend-arrow" aria-hidden="true">
                            {% if delta_mes_anterior_estado == 'positive' %}&#9650;{% elif delta_mes_anterior_estado == 'negative' %}&#9660;{% else %}&#8213;{% endif %}
                        </span>
                        <span>{{ delta_mes_anterior_str }}</span>
                    </div>
                </article>
            </div>

            <div class="content-topbar__actions">
                <aside class="actions acciones-comisiones">
                    <button
                        type="button"
                        class="btn btn-primary validar-comisiones"
                        aria-label="Validar comisiones"
                    >
                        Validar comisiones
                    </button>
                    <button
                        type="button"
                        class="btn btn-outline-danger registrar-incidencia"
                        aria-label="Registrar incidencia"
                        onclick="window.location.href='{% url 'registrar_incidencia' %}'"
                    >
                        Registrar incidencia
                    </button>
                </aside>
            </div>
        </section>

        <section class="content main-layout">
            <aside id="filtersPanel" class="filters-panel-shell" tabindex="-1">
                <div class="filters-sheet-header">
                    <h3 class="filters-sheet-title">Filtros</h3>
                    <div class="filters-sheet-header-actions">
                        {% if active_filters %}
                        <button type="button" class="clear-filters-btn filters-sheet-clear" data-clear-all="true" aria-label="Limpiar filtros">
                            Limpiar
                        </button>
                        {% endif %}
                        <button type="button" class="filters-sheet-close" data-filters-close aria-label="Cerrar filtros">&times;</button>
                    </div>
                </div>
                <form class="filters filters-panel" method="get" id="mis-ventas-filtros-form">
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                    <input type="hidden" name="dir" value="{{ sort_dir }}">
                    <div class="filter-accordion is-open">
                        <button
                            type="button"
                            class="filter-accordion__header"
                            aria-expanded="true"
                            aria-controls="filtros-periodo-content"
                        >
                            <span>Periodo</span>
                            <span class="filter-accordion__icon" aria-hidden="true"></span>
                        </button>
                        <div class="filter-accordion__content" id="filtros-periodo-content">
                            <div class="filter-group">
                                <div class="field">
                                    <label for="desde">Desde</label>
                                    <input type="month" id="desde" name="desde" value="{{ fecha_desde }}">
                                </div>
                                <div class="field">
                                    <label for="hasta">Hasta</label>
                                    <input type="month" id="hasta" name="hasta" value="{{ fecha_hasta }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-accordion">
                        <button
                            type="button"
                            class="filter-accordion__header"
                            aria-expanded="false"
                            aria-controls="filtros-vehiculo-content"
                        >
                            <span>Veh&iacute;culo / Matr&iacute;cula</span>
                            <span class="filter-accordion__icon" aria-hidden="true"></span>
                        </button>
                        <div class="filter-accordion__content" id="filtros-vehiculo-content">
                            <div class="filter-group">
                                <div class="field">
                                    <label for="matricula">Matr&iacute;cula</label>
                                    <input id="matricula" name="matricula" list="matricula-opciones" value="{{ filtros.matricula }}" autocomplete="off">
                                    <datalist id="matricula-opciones">
                                        {% for opcion in matriculas_opciones %}
                                        <option value="{{ opcion }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div class="field">
                                    <label for="idv">IDV</label>
                                    <input id="idv" name="idv" list="idv-opciones" value="{{ filtros.idv }}" autocomplete="off">
                                    <datalist id="idv-opciones">
                                        {% for opcion in idv_opciones %}
                                        <option value="{{ opcion }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div class="field">
                                    <label for="tipo_venta">Tipo venta</label>
                                    <input id="tipo_venta" name="tipo_venta" list="tipo-venta-opciones" value="{{ filtros.tipo_venta }}" autocomplete="off">
                                    <datalist id="tipo-venta-opciones">
                                        {% for opcion in tipo_venta_opciones %}
                                        <option value="{{ opcion.value }}">{{ opcion.label }}</option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-accordion">
                        <button
                            type="button"
                            class="filter-accordion__header"
                            aria-expanded="false"
                            aria-controls="filtros-cliente-content"
                        >
                            <span>Cliente</span>
                            <span class="filter-accordion__icon" aria-hidden="true"></span>
                        </button>
                        <div class="filter-accordion__content" id="filtros-cliente-content">
                            <div class="filter-group">
                                <div class="field">
                                    <label for="dni">DNI</label>
                                    <input id="dni" name="dni" list="dni-opciones" value="{{ filtros.dni }}" autocomplete="off">
                                    <datalist id="dni-opciones">
                                        {% for opcion in dni_opciones %}
                                        <option value="{{ opcion }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div class="field">
                                    <label for="tipo_cliente">Tipo de cliente</label>
                                    <select id="tipo_cliente" name="tipo_cliente" class="js-combobox" data-combobox-placeholder="Buscar tipo de cliente...">
                                        <option value="">Todos</option>
                                        {% for opcion in tipo_cliente_opciones %}
                                        <option value="{{ opcion.value }}" {% if filtros.tipo_cliente == opcion.value %}selected{% endif %}>{{ opcion.label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="nombre_cliente">Nombre de cliente</label>
                                    <input id="nombre_cliente" name="nombre_cliente" list="nombre-cliente-opciones" value="{{ filtros.nombre_cliente }}" autocomplete="off">
                                    <datalist id="nombre-cliente-opciones">
                                        {% for opcion in nombre_cliente_opciones %}
                                        <option value="{{ opcion }}"></option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field field-submit">
                        <button type="button" class="btn btn-secondary filters-sheet-cancel" data-filters-close>Cerrar</button>
                        <button type="submit" class="btn btn-primary aplicar-filtro" disabled>Aplicar filtros</button>
                    </div>
                </form>
            </aside>

            <section class="results-panel table-panel" aria-live="polite">
                {% if total_resultados > 0 or active_filters %}
                <div class="results-summary-row">
                    {% if total_resultados > 0 %}
                    <p class="results-meta">
                        Mostrando <strong id="results-visible-count">{{ initial_visible_count }}</strong> de {{ total_resultados }}
                    </p>
                    {% endif %}

                    {% if active_filters %}
                    <div class="active-filters active-filters--classic" aria-label="Filtros activos">
                        <span class="active-filters-label">Filtros activos</span>
                        <div class="active-filters-chips">
                            {% for chip in active_filters %}
                            <button
                                type="button"
                                class="filter-chip"
                                data-clear-fields="{{ chip.fields|join:',' }}"
                                aria-label="Eliminar filtro {{ chip.title }}"
                            >
                                <span>{{ chip.label }}</span>
                                <span class="chip-remove" aria-hidden="true">&times;</span>
                            </button>
                            {% endfor %}
                        </div>
                        <button type="button" class="clear-filters-btn clear-filters-btn--classic" data-clear-all="true">
                            Limpiar todos
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if ventas %}
                <div class="table-wrap">
                    <table class="mis-ventas-results">
                        <thead>
                            <tr>
                                <th class="select-col-header">
                                    <input
                                        type="checkbox"
                                        id="select-all-sales"
                                        class="sales-select-all"
                                        aria-label="Seleccionar todas las ventas filtradas"
                                    >
                                </th>
                                <th
                                    class="is-primary-col th-sortable{% if sort_by == 'matricula' %} is-sorted{% endif %}"
                                    aria-sort="{% if sort_by == 'matricula' %}{% if sort_dir == 'asc' %}ascending{% else %}descending{% endif %}{% else %}none{% endif %}"
                                >
                                    <div class="th-sort-wrap">
                                        <span class="th-label">Matricula</span>
                                        <a
                                            class="sort-icon-btn{% if sort_by == 'matricula' %} active{% endif %}"
                                            href="?desde={{ fecha_desde }}&hasta={{ fecha_hasta }}{% if filtros.matricula %}&matricula={{ filtros.matricula|urlencode }}{% endif %}{% if filtros.idv %}&idv={{ filtros.idv|urlencode }}{% endif %}{% if filtros.tipo_venta %}&tipo_venta={{ filtros.tipo_venta|urlencode }}{% endif %}{% if filtros.dni %}&dni={{ filtros.dni|urlencode }}{% endif %}{% if filtros.tipo_cliente %}&tipo_cliente={{ filtros.tipo_cliente|urlencode }}{% endif %}{% if filtros.nombre_cliente %}&nombre_cliente={{ filtros.nombre_cliente|urlencode }}{% endif %}&sort=matricula&dir={{ siguiente_direccion.matricula }}"
                                            aria-label="Ordenar por matricula"
                                        >
                                            <span class="th-icon" aria-hidden="true">{% if sort_by == 'matricula' and sort_dir == 'asc' %}&#9650;{% else %}&#9660;{% endif %}</span>
                                        </a>
                                    </div>
                                </th>
                                <th
                                    class="th-sortable{% if sort_by == 'fecha' %} is-sorted{% endif %}"
                                    aria-sort="{% if sort_by == 'fecha' %}{% if sort_dir == 'asc' %}ascending{% else %}descending{% endif %}{% else %}none{% endif %}"
                                >
                                    <div class="th-sort-wrap">
                                        <span class="th-label">Fecha</span>
                                        <a
                                            class="sort-icon-btn{% if sort_by == 'fecha' %} active{% endif %}"
                                            href="?desde={{ fecha_desde }}&hasta={{ fecha_hasta }}{% if filtros.matricula %}&matricula={{ filtros.matricula|urlencode }}{% endif %}{% if filtros.idv %}&idv={{ filtros.idv|urlencode }}{% endif %}{% if filtros.tipo_venta %}&tipo_venta={{ filtros.tipo_venta|urlencode }}{% endif %}{% if filtros.dni %}&dni={{ filtros.dni|urlencode }}{% endif %}{% if filtros.tipo_cliente %}&tipo_cliente={{ filtros.tipo_cliente|urlencode }}{% endif %}{% if filtros.nombre_cliente %}&nombre_cliente={{ filtros.nombre_cliente|urlencode }}{% endif %}&sort=fecha&dir={{ siguiente_direccion.fecha }}"
                                            aria-label="Ordenar por fecha"
                                        >
                                            <span class="th-icon" aria-hidden="true">{% if sort_by == 'fecha' and sort_dir == 'asc' %}&#9650;{% else %}&#9660;{% endif %}</span>
                                        </a>
                                    </div>
                                </th>
                                <th
                                    class="th-sortable{% if sort_by == 'idv' %} is-sorted{% endif %}"
                                    aria-sort="{% if sort_by == 'idv' %}{% if sort_dir == 'asc' %}ascending{% else %}descending{% endif %}{% else %}none{% endif %}"
                                >
                                    <div class="th-sort-wrap">
                                        <span class="th-label">IDV</span>
                                        <a
                                            class="sort-icon-btn{% if sort_by == 'idv' %} active{% endif %}"
                                            href="?desde={{ fecha_desde }}&hasta={{ fecha_hasta }}{% if filtros.matricula %}&matricula={{ filtros.matricula|urlencode }}{% endif %}{% if filtros.idv %}&idv={{ filtros.idv|urlencode }}{% endif %}{% if filtros.tipo_venta %}&tipo_venta={{ filtros.tipo_venta|urlencode }}{% endif %}{% if filtros.dni %}&dni={{ filtros.dni|urlencode }}{% endif %}{% if filtros.tipo_cliente %}&tipo_cliente={{ filtros.tipo_cliente|urlencode }}{% endif %}{% if filtros.nombre_cliente %}&nombre_cliente={{ filtros.nombre_cliente|urlencode }}{% endif %}&sort=idv&dir={{ siguiente_direccion.idv }}"
                                            aria-label="Ordenar por idv"
                                        >
                                            <span class="th-icon" aria-hidden="true">{% if sort_by == 'idv' and sort_dir == 'asc' %}&#9650;{% else %}&#9660;{% endif %}</span>
                                        </a>
                                    </div>
                                </th>
                                <th
                                    class="th-sortable{% if sort_by == 'tipo_venta' %} is-sorted{% endif %}"
                                    aria-sort="{% if sort_by == 'tipo_venta' %}{% if sort_dir == 'asc' %}ascending{% else %}descending{% endif %}{% else %}none{% endif %}"
                                >
                                    <div class="th-sort-wrap">
                                        <span class="th-label">Tipo venta</span>
                                        <a
                                            class="sort-icon-btn{% if sort_by == 'tipo_venta' %} active{% endif %}"
                                            href="?desde={{ fecha_desde }}&hasta={{ fecha_hasta }}{% if filtros.matricula %}&matricula={{ filtros.matricula|urlencode }}{% endif %}{% if filtros.idv %}&idv={{ filtros.idv|urlencode }}{% endif %}{% if filtros.tipo_venta %}&tipo_venta={{ filtros.tipo_venta|urlencode }}{% endif %}{% if filtros.dni %}&dni={{ filtros.dni|urlencode }}{% endif %}{% if filtros.tipo_cliente %}&tipo_cliente={{ filtros.tipo_cliente|urlencode }}{% endif %}{% if filtros.nombre_cliente %}&nombre_cliente={{ filtros.nombre_cliente|urlencode }}{% endif %}&sort=tipo_venta&dir={{ siguiente_direccion.tipo_venta }}"
                                            aria-label="Ordenar por tipo de venta"
                                        >
                                            <span class="th-icon" aria-hidden="true">{% if sort_by == 'tipo_venta' and sort_dir == 'asc' %}&#9650;{% else %}&#9660;{% endif %}</span>
                                        </a>
                                    </div>
                                </th>
                                <th
                                    class="th-sortable{% if sort_by == 'ud_financiadas' %} is-sorted{% endif %}"
                                    aria-sort="{% if sort_by == 'ud_financiadas' %}{% if sort_dir == 'asc' %}ascending{% else %}descending{% endif %}{% else %}none{% endif %}"
                                >
                                    <div class="th-sort-wrap">
                                        <span class="th-label">UD financiadas</span>
                                        <a
                                            class="sort-icon-btn{% if sort_by == 'ud_financiadas' %} active{% endif %}"
                                            href="?desde={{ fecha_desde }}&hasta={{ fecha_hasta }}{% if filtros.matricula %}&matricula={{ filtros.matricula|urlencode }}{% endif %}{% if filtros.idv %}&idv={{ filtros.idv|urlencode }}{% endif %}{% if filtros.tipo_venta %}&tipo_venta={{ filtros.tipo_venta|urlencode }}{% endif %}{% if filtros.dni %}&dni={{ filtros.dni|urlencode }}{% endif %}{% if filtros.tipo_cliente %}&tipo_cliente={{ filtros.tipo_cliente|urlencode }}{% endif %}{% if filtros.nombre_cliente %}&nombre_cliente={{ filtros.nombre_cliente|urlencode }}{% endif %}&sort=ud_financiadas&dir={{ siguiente_direccion.ud_financiadas }}"
                                            aria-label="Ordenar por unidades financiadas"
                                        >
                                            <span class="th-icon" aria-hidden="true">{% if sort_by == 'ud_financiadas' and sort_dir == 'asc' %}&#9650;{% else %}&#9660;{% endif %}</span>
                                        </a>
                                    </div>
                                </th>
                                <th
                                    class="th-sortable{% if sort_by == 'dni' %} is-sorted{% endif %}"
                                    aria-sort="{% if sort_by == 'dni' %}{% if sort_dir == 'asc' %}ascending{% else %}descending{% endif %}{% else %}none{% endif %}"
                                >
                                    <div class="th-sort-wrap">
                                        <span class="th-label">DNI</span>
                                        <a
                                            class="sort-icon-btn{% if sort_by == 'dni' %} active{% endif %}"
                                            href="?desde={{ fecha_desde }}&hasta={{ fecha_hasta }}{% if filtros.matricula %}&matricula={{ filtros.matricula|urlencode }}{% endif %}{% if filtros.idv %}&idv={{ filtros.idv|urlencode }}{% endif %}{% if filtros.tipo_venta %}&tipo_venta={{ filtros.tipo_venta|urlencode }}{% endif %}{% if filtros.dni %}&dni={{ filtros.dni|urlencode }}{% endif %}{% if filtros.tipo_cliente %}&tipo_cliente={{ filtros.tipo_cliente|urlencode }}{% endif %}{% if filtros.nombre_cliente %}&nombre_cliente={{ filtros.nombre_cliente|urlencode }}{% endif %}&sort=dni&dir={{ siguiente_direccion.dni }}"
                                            aria-label="Ordenar por dni"
                                        >
                                            <span class="th-icon" aria-hidden="true">{% if sort_by == 'dni' and sort_dir == 'asc' %}&#9650;{% else %}&#9660;{% endif %}</span>
                                        </a>
                                    </div>
                                </th>
                                <th
                                    class="is-secondary-col th-sortable{% if sort_by == 'tipo_cliente' %} is-sorted{% endif %}"
                                    aria-sort="{% if sort_by == 'tipo_cliente' %}{% if sort_dir == 'asc' %}ascending{% else %}descending{% endif %}{% else %}none{% endif %}"
                                >
                                    <div class="th-sort-wrap">
                                        <span class="th-label">Tipo cliente</span>
                                        <a
                                            class="sort-icon-btn{% if sort_by == 'tipo_cliente' %} active{% endif %}"
                                            href="?desde={{ fecha_desde }}&hasta={{ fecha_hasta }}{% if filtros.matricula %}&matricula={{ filtros.matricula|urlencode }}{% endif %}{% if filtros.idv %}&idv={{ filtros.idv|urlencode }}{% endif %}{% if filtros.tipo_venta %}&tipo_venta={{ filtros.tipo_venta|urlencode }}{% endif %}{% if filtros.dni %}&dni={{ filtros.dni|urlencode }}{% endif %}{% if filtros.tipo_cliente %}&tipo_cliente={{ filtros.tipo_cliente|urlencode }}{% endif %}{% if filtros.nombre_cliente %}&nombre_cliente={{ filtros.nombre_cliente|urlencode }}{% endif %}&sort=tipo_cliente&dir={{ siguiente_direccion.tipo_cliente }}"
                                            aria-label="Ordenar por tipo de cliente"
                                        >
                                            <span class="th-icon" aria-hidden="true">{% if sort_by == 'tipo_cliente' and sort_dir == 'asc' %}&#9650;{% else %}&#9660;{% endif %}</span>
                                        </a>
                                    </div>
                                </th>
                                <th
                                    class="th-sortable{% if sort_by == 'nombre_cliente' %} is-sorted{% endif %}"
                                    aria-sort="{% if sort_by == 'nombre_cliente' %}{% if sort_dir == 'asc' %}ascending{% else %}descending{% endif %}{% else %}none{% endif %}"
                                >
                                    <div class="th-sort-wrap">
                                        <span class="th-label">Nombre cliente</span>
                                        <a
                                            class="sort-icon-btn{% if sort_by == 'nombre_cliente' %} active{% endif %}"
                                            href="?desde={{ fecha_desde }}&hasta={{ fecha_hasta }}{% if filtros.matricula %}&matricula={{ filtros.matricula|urlencode }}{% endif %}{% if filtros.idv %}&idv={{ filtros.idv|urlencode }}{% endif %}{% if filtros.tipo_venta %}&tipo_venta={{ filtros.tipo_venta|urlencode }}{% endif %}{% if filtros.dni %}&dni={{ filtros.dni|urlencode }}{% endif %}{% if filtros.tipo_cliente %}&tipo_cliente={{ filtros.tipo_cliente|urlencode }}{% endif %}{% if filtros.nombre_cliente %}&nombre_cliente={{ filtros.nombre_cliente|urlencode }}{% endif %}&sort=nombre_cliente&dir={{ siguiente_direccion.nombre_cliente }}"
                                            aria-label="Ordenar por nombre de cliente"
                                        >
                                            <span class="th-icon" aria-hidden="true">{% if sort_by == 'nombre_cliente' and sort_dir == 'asc' %}&#9650;{% else %}&#9660;{% endif %}</span>
                                        </a>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venta in ventas %}
                            <tr data-result-row {% if forloop.counter > initial_visible_rows %}hidden{% endif %}>
                                <td class="select-col-cell center">
                                    <input
                                        type="checkbox"
                                        class="sale-select"
                                        data-select-venta
                                        value="{{ venta.id }}"
                                        aria-label="Seleccionar venta {{ venta.matricula }} (IDV {{ venta.idv }})"
                                    >
                                </td>
                                <td class="bold is-primary-col">{{ venta.matricula|default:"--" }}</td>
                                <td class="center">{% if venta.fecha_venta %}{{ venta.fecha_venta|date:"d/m/Y" }}{% else %}--{% endif %}</td>
                                <td class="center">{{ venta.idv|default_if_none:"--" }}</td>
                                <td>{{ venta.get_tipo_venta_display|default:"--" }}</td>
                                <td class="center">{{ venta.ud_financiadas|default_if_none:"--" }}</td>
                                <td class="center">{{ venta.dni|default:"--" }}</td>
                                <td class="center is-secondary-col">{{ venta.get_tipo_cliente_display|default:"--" }}</td>
                                <td>{{ venta.nombre_cliente|default:"--" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="results-actions-row" data-export-url="{% url 'exportar_mis_ventas' %}">
                    <div class="results-actions-left">
                        <div class="export-desktop-group">
                            <button type="button" class="export-btn export-btn-excel" id="export-excel-btn">Exportar Excel</button>
                            <button type="button" class="export-btn export-btn-csv" id="export-csv-btn">Exportar CSV</button>
                        </div>
                        <div class="export-mobile-group">
                            <div class="export-menu-wrap export-menu-wrap-mobile">
                                <button
                                    type="button"
                                    class="export-btn export-btn-main"
                                    id="export-menu-toggle"
                                    aria-haspopup="true"
                                    aria-expanded="false"
                                    aria-controls="export-options-menu-mobile"
                                >
                                    Exportar
                                    <span class="export-btn-caret" aria-hidden="true">&#9662;</span>
                                </button>
                                <div class="export-options-menu" id="export-options-menu-mobile" role="menu" hidden>
                                    <button type="button" class="export-option-btn" data-export-format="excel" role="menuitem">Excel</button>
                                    <button type="button" class="export-option-btn" data-export-format="csv" role="menuitem">CSV</button>
                                </div>
                            </div>
                        </div>
                        <span class="results-export-count" id="selected-sales-count">0 seleccionadas</span>
                    </div>
                    <div class="results-actions-right">
                        <button
                            type="button"
                            id="load-more-results"
                            class="load-more-btn"
                            data-page-size="{{ initial_visible_rows }}"
                            aria-label="Cargar mas resultados"
                            {% if total_resultados <= initial_visible_rows %}hidden{% endif %}
                        >
                            <span class="load-more-btn__text">Cargar m&aacute;s</span>
                            <span class="load-more-btn__spinner" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="empty-state" role="status" aria-live="polite">
                    <h3 class="empty-state-title">No hay resultados</h3>
                    <p class="empty-state-text">Prueba a ajustar los filtros o ampliar el periodo.</p>
                    <a class="empty-state-action" href="{% url 'mis_ventas' %}">Limpiar filtros</a>
                </div>
                {% endif %}
            </section>
        </section>
        <div class="filters-backdrop" aria-hidden="true"></div>
    </div>
<script>
    (function () {
        const navEntry =
            window.performance &&
            window.performance.getEntriesByType &&
            window.performance.getEntriesByType("navigation")[0];
        const isReload = navEntry
            ? navEntry.type === "reload"
            : window.performance &&
              window.performance.navigation &&
              window.performance.navigation.type === 1;

        if (isReload && window.location.search) {
            window.location.replace(window.location.pathname);
        }
    })();

    (function () {
        const desde = document.getElementById("desde");
        const hasta = document.getElementById("hasta");
        if (!desde || !hasta) return;

        function syncDateLimits() {
            hasta.min = desde.value || "";
            desde.max = hasta.value || "";
            if (desde.value && hasta.value && hasta.value < desde.value) {
                hasta.value = desde.value;
            }
        }
        desde.addEventListener("change", syncDateLimits);
        hasta.addEventListener("change", syncDateLimits);
        syncDateLimits();
    })();

    (function () {
        const tableBody = document.querySelector(".mis-ventas-results tbody");
        if (!tableBody) return;
        const cells = tableBody.querySelectorAll("td");
        cells.forEach((cell) => {
            if (cell.querySelector("a, button, input, select, textarea, label")) return;
            const text = cell.textContent.trim();
            if (text === "" || /^none$/i.test(text) || /^null$/i.test(text) || /^undefined$/i.test(text)) {
                cell.textContent = "--";
            }
        });
    })();

</script>
    <script src="{% static 'js/filter_accordion.js' %}"></script>
    <script src="{% static 'js/mis_ventas_results.js' %}"></script>
    <script src="{% static 'js/mis_ventas_filters_toggle.js' %}"></script>
    <script src="{% static 'js/registrar_incidencia_combobox.js' %}"></script>
    <script src="{% static 'js/user_menu.js' %}"></script>
    <script src="{% static 'js/nav_tabs.js' %}"></script>
</body>
</html>




